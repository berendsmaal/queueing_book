\section
{$M/M/1$ queue}
%{$\mathbf{M/M/1}$ queue}
\label{sec:mm1}



\opt{solutionfiles}{
\subsection*{Theory and Exercises}
\Opensolutionfile{hint}
\Opensolutionfile{ans}
}

In the $M/M/1$ queue, one server serves jobs arriving with exponentially distributed inter-arrival times and each job requires an exponentially distributed processing time.
With the level-crossing equations~\cref{eq:25} we derive a number of important results for this queueing process.

Recall from~\cref{sec:queu-proc-as} that we can construct the $M/M/1$ queue as a reflected random walk where the arrivals are generated by a Poisson process $N_\lambda(t)$ and the departures (provided the number $L(t)$ in the system is positive) are generated according to the Poisson process $N_\mu(t)$.
Since the rates of these processes do not depend on the state of the random walk nor on the queue process, it follows that $\lambda(n)=\lambda$ for all $n \geq 0$ and $\mu(n)=\mu$ for all $n \geq 1$.
Thus,~\cref{eq:25} reduces to
\begin{equation*}
 p(n+1) = \frac{\lambda(n)}{\mu(n+1)} p(n) = \frac{\lambda}{\mu} p(n) = \rho p(n),
\end{equation*}
where we use the definition of the load $\rho=\lambda/\mu$. Since this
holds for any $n\geq 0$, it follows with recursion that
\begin{equation*}
 p(n+1) = \rho^{n+1} p(0).
\end{equation*}
Then, by using normalization, 
% \begin{equation*}
% 1= \sum_{n=0}^\infty p(n) = p(0)\sum_{n=0}^\infty \rho^n = \frac{p(0)}{1-\rho},
% \end{equation*}
it follows from~\cref{eq:20} and~\cref{eq:61} that
\begin{align}\label{eq:23}
p(0) &=1-\rho, & p(n) &= (1-\rho)\rho^{n}.
\end{align}

It is now easy to compute the most important performance measures.
The utilization of the server is $\rho=\lambda/\mu$, as observed above.
Then, with a bit of algebra,
\begin{align}\label{eq:el}
 \E L &= \frac \rho{1-\rho}, & \V L &= \frac{\rho}{(1-\rho)^2}, & \P{L> n} &= \rho^{n+1}.
\end{align}




\begin{extra}
 What is the interpretation of $\sum_{n=1}^\infty p(n)$?
\begin{solution}
First, note that $p(0)$ must be the fraction of time the server is idle.
Hence, the fraction of time the server is busy, i.e., the utilization, is
\begin{equation*}
 1-p(0) = \rho = \sum_{n=1}^\infty p(n).
\end{equation*}
Here the last equation has the interpretation of the fraction of time
the system contains at least 1 job. 
\end{solution}
\end{extra}


\begin{extra} \clabel{ex:12}
Derive~\cref{eq:el} with indicator functions.
\begin{solution}
A bit long, but I spell out every step:
\begin{align*}
\E L &= \sum_{n=0}^\infty n p(n) \\
&= \sum_{n=0}^\infty \sum_{i=1}^n \1{i\leq n} p(n) && n=\sum_{i=1}^n \1{i\leq n}\\
&= \sum_{n=0}^\infty \sum_{i=1}^\infty \1{i\leq n} p(n) && i>n\implies \1{i\leq n} = 0\\
&= \sum_{i=1}^\infty \sum_{n=0}^\infty \1{i\leq n} p(n) &&\text{Fubini} \\
&= \sum_{i=1}^\infty \sum_{n=i}^\infty p(n) && n < i \implies \1{i\leq n}=0 \\
&= \sum_{i=1}^\infty \sum_{n=i}^\infty (1-\rho)\rho^n && p(n) = (1-\rho)\rho^n \\
&= \sum_{i=1}^\infty \sum_{n=0}^\infty (1-\rho)\rho^{n+i} && n\to n+i \\
&= \sum_{i=1}^\infty (1-\rho)\rho^i \sum_{n=0}^\infty \rho^n && \rho^{n+i}=\rho^i \rho^n\\
&= \sum_{i=1}^\infty (1-\rho)\rho^i \frac1{1-\rho} \\
&= \sum_{i=1}^\infty \rho^i \\
&= \sum_{i=0}^\infty \rho^{i+1} && i\to i+1\\
&= \rho \sum_{i=0}^\infty \rho^i \\
&= \frac{\rho}{1-\rho}.
\end{align*}
Note that, since the summands are positive, we can use Fubini's theorem
to justify the interchange of the summations.
\end{solution}
\end{extra}

\begin{exercise} \clabel{ex:14}
Derive ~\cref{eq:el} by differentiating the left-hand and right-hand side of
 the standard formula for a geometric series: $\sum_{n=0}^{\infty}\rho^n = (1-\rho)^{-1}$ for $|\rho| < 1$. 
\begin{hint}
 Observe that we just need to compute the first second moment of a geometric random variable.
\end{hint}
\begin{solution}
Differentiate the left and right-hand side with respect to
$\rho$ and then multiply with $\rho$ to get
\begin{equation*}
\dfrac{\rho}{(1-\rho)^2}=\sum_{n=0}^{\infty}n\rho^n.
\end{equation*}
Then multiply both sides by $(1-\rho)$ (recall that $p(n) = (1-\rho)\rho^n$).

Differentiating twice gives $\E{L^2}$, after which $\V L$ follows easily.
\end{solution}
\end{exercise}

\begin{extra}\clabel{ex:34}
 Now use moment-generating functions to derive~\cref{eq:el}. 
\begin{solution}
\begin{equation*}
 \begin{split}
 M_L(s) 
&= \E{e^{s L}} = \sum_{n=0}^\infty e^{s n}p(n) = (1-\rho) \sum_n e^{s n} \rho^n=\frac{1-\rho}{1-e^{s}\rho},
 \end{split}
\end{equation*}
where we assume that $s$ is such that $e^s \rho < 1$. Then, 
\begin{equation*}
 M_L'(s) = (1-\rho) \frac{1}{(1-e^s\rho)^2} e^s \rho.
\end{equation*}
Hence, $\E L = M_L'(0) = \rho/(1-\rho)$.
\end{solution}
\end{extra}



\begin{extra}\clabel{ex:56}
 Derive
\begin{equation}\label{eq:80}
 \E{L^2}= (1-\rho) \sum_{n=0}^\infty n^2 \rho^n = \frac{2\rho^2}{(1-\rho)^2} + \frac{\rho}{1-\rho}
\end{equation}
by differentiation the standard formula for a geometric series twice.
\begin{solution}
 Starting from the result of~\cref{ex:14}, differentiating and multiplying with $\rho$ a second time yields
\begin{equation*}
 \begin{split}
\rho \frac{(1-\rho)^2 + \rho2(1-\rho)}{(1-\rho)^4} 
&= \rho \frac{1-2\rho+\rho^2 + 2\rho-2\rho^2}{(1-\rho)^4} \\
&= \rho \frac{1-\rho^2}{(1-\rho)^4} \\
&=\rho \dfrac{1+\rho}{(1-\rho)^3}\\
&=\sum_{n=0}^{\infty}n^2\rho^n,
 \end{split}
\end{equation*}
and hence
\begin{equation*}
(1-\rho)\sum_{n=0}^{\infty}n^2\rho^n = \rho\dfrac{1+\rho}{(1-\rho)^2}.
\end{equation*}
Recall that $p(n) = (1-\rho)\rho^n$. 
\end{solution}
\end{extra}


\begin{extra} Show~\cref{eq:80} by noting that
$\sum_{i=1}^n i= n(n+1)/2$ from which we get that
$n^2 = -n + 2\sum_{i=1}^n i$. Substitute this relation into
$\sum_n n^2 \rho^n$ and simplify.
\begin{solution}
\begin{align*}
 \sum_{n=0}^\infty n^2 \rho^n 
&= \sum_{n=0}^\infty \left(\sum_{i=1}^\infty 2i \1{i\leq n} - n\right)\rho^n 
= \sum_{n=0}^\infty \sum_{i=0}^\infty 2i\1{i\leq n}\rho^n - \sum_{n=0}^\infty n\rho^n \\
&= \sum_{i=0}^\infty 2i \sum_{n=i}^\infty \rho^n - \frac{\E L}{1-\rho} 
= \sum_{i=0}^\infty 2i \rho^i \sum_{n=0}^\infty \rho^n - \frac{\E L}{1-\rho} \\
&= \frac2{1-\rho} \sum_{i=0}^\infty i \rho^i - \frac{\E L}{1-\rho} 
= \frac2{(1-\rho)^2} \E L - \frac{\E L}{1-\rho} \\
&= \frac{\E L}{1-\rho} \left(\frac2{1-\rho} - 1\right) 
= \frac{\E L}{1-\rho} \frac{1+\rho}{1-\rho} \\
&= \frac{\rho}{1-\rho} \frac{1+\rho}{(1-\rho)^2}.
\end{align*}
\end{solution}
\end{extra}

\begin{extra} Derive~\cref{eq:80} by
 using the moment-generating functions.
\begin{solution}
Using the results of~\cref{ex:34} gives
\begin{equation*}
 \E{L^2}= M''(0)= \frac{2\rho^2}{(1-\rho)^2} + \frac{\rho}{1-\rho}.
\end{equation*}
\end{solution}
\end{extra}

\begin{extra} Show that for the $M/M/1$ queue $\V L = \rho/(1-\rho)^2$.
\begin{solution}
\begin{equation*}
\V L = \E{L^2} - (\E L)^2 = \frac{\rho(1+\rho)}{(1-\rho)^2}-\frac{\rho^2}{(1-\rho)^2} = \frac{\rho}{(1-\rho)^2}.
\end{equation*}
\end{solution}
\end{extra}

\begin{extra}
Show that for the $M/M/1$ queue the SCV of $L$ is $1/\rho$. What do you conclude from this?
\begin{solution}
To see how large this variance is, relative to the mean number of jobs
in the system, we typically consider the squared coefficient of
variation (SCV). As $\E L = \rho/(1-\rho)$,
\begin{equation*}
 \frac{\V L}{(\E{L})^2} = \frac 1 \rho.
\end{equation*}
Thus, the SCV becomes smaller as $\rho$ increases, but does not become
lower than $1$. So, realizing that the SCV of the exponential
distribution is 1, the distribution of the number of jobs in the
system has larger relative variability than the exponential
distribution.
\end{solution}
\end{extra}


\begin{extra}
 Show that the excess probability, i.e., the probability that a long queue occurs, is 
$\P{L\geq n} = \rho^n$.
\begin{hint}
$\P{L\geq n} = \sum_{k\geq n} p(k)$.
\end{hint}
\begin{solution}
 \begin{equation*}
 \begin{split}
 \P{L\geq n} 
 &= \sum_{k=n}^\infty p(k) = \sum_{k=n}^\infty p(0)\rho^k = (1-\rho)\sum_{k=n}^\infty \rho^k \\
 &= (1-\rho)\rho^n \sum_{k=0}^\infty\rho^k = (1-\rho) \rho^n \frac1{1-\rho} = \rho^n.
\end{split}
\end{equation*}
\end{solution}
\end{extra}


\begin{extra}
 Explain that for the $M/M/1$ queue $\E{L_Q} = \sum_{n=1}^\infty (n-1)\pi(n)$ and use this to find that $\E{L_Q}=\rho^2/(1-\rho)$.
\begin{solution}
 The fraction of time the system contains $n$ jobs is $\pi(n)$ (by
 PASTA). When the system contains $n>0$ jobs, the number in queue
 is one less, i.e., $n-1$.

 \begin{equation*}
 \begin{split}
\E{L_Q} 
&= \sum_{n=1}^\infty (n-1)\pi(n) 
= (1-\rho)\sum_{n=1}^\infty (n-1) \rho^n\\
&= \rho (1-\rho)\sum_{n=1}^\infty (n-1) \rho^{n-1}
= \rho \sum_{n=1}^\infty (n-1) \pi(n-1)\\
&= \rho \sum_{n=0}^\infty n \pi(n)
= \rho \frac{\rho}{1-\rho}.
 \end{split}
 \end{equation*}

Another way to get the same result is by splitting: 
\begin{equation*}
 \begin{split}
\E{L_Q} 
&= \sum_{n=1}^\infty (n-1)\pi(n) 
=\sum_{n=1}^\infty n\pi(n) -\sum_{n=1}^\infty \pi(n)\\
&= \E L - (1-\pi(0)) = \E L - \rho.
 \end{split}
\end{equation*}
\end{solution}
\end{extra}


Let us interpret~\cref{eq:el}.
The fact that $\E L \sim (1-\rho)^{-1}$ for $\rho\to 1$ implies that the average waiting time increases very fast when $\rho\to1$.
If we want to avoid long waiting times, this formula tells us that situations with $\rho\approx 1$ should be avoided.
As a practical guideline, it is typically best to keep $\rho$ quite a bit below 1, and accept that servers are not fully utilized.

Clearly, the probability that the queue length exceeds some threshold decreases geometrically fast (for $\rho<1$).
If we make the simple assumption that customers decide to leave (or rather, not join) the system when the queue is longer than $9$ say, then $\P{L\geq 10} = \rho^{10}$ is an estimator for the fraction of customers lost.


\paragraph{Supermarket Planning}

Let us consider the example of cashier planning of a supermarket to
demonstrate how to use the tools we developed up to now. Out of
necessity, our approach is a bit heavy-handed---Turning the example
into a practically useful scheme requires more sophisticated queueing
models and data assembly---but the present example contains the
essential analytic steps to solve the planning problem.

The \emph{service objective} is to determine the minimal service
capacity $c$ (i.e., the number of cashiers) such that the fraction of the time that more than 
10 people are in queue is less than 1\%. (If the supermarket has 3 cashiers open, 10 people in queue means about 3 people per queue.)

The next step is to find the \emph{relevant data}: the arrival process and the service time distribution. For the arrival process it is reasonable to model it as a Poisson process. There are many potential customers, each choosing with a small probability to go to the supermarket at a certain moment in time. Thus, we only have to characterize the arrival rate. Estimating this for a supermarket is relatively easy: the cash registers track all customers
payments. Thus, we know the number of customers that left the shop,
hence entered the shop. (We neglect the time customers spend in the
shop.) Based on these data we make a \emph{demand profile}: the
average number of customers arriving per hour, cf.~\cref{fig:loadprofile}. Then we model the arrival process as Poisson with an arrival rate that is constant during a certain hour as specified by the demand profile. 

\begin{figure}[t]
 \centering
\begin{tikzpicture}[scale=.7]
 	%axis
	\draw[->] (0,0) -- coordinate (x axis mid) (13.5,0);
 	\draw[->] (0,0) -- coordinate (y axis mid) (0,5.5);
 	%ticks
 	\foreach \x in {0,...,13}
 \pgfmathsetmacro{\my}{int(\x+8)}
 		\draw (\x,1pt) -- (\x,-3pt)
			node[anchor=north] {$\my$};
 	\foreach \y in {0,...,5}
 \pgfmathsetmacro{\my}{int(\y*40)}
 		\draw (1pt,\y) -- (-3pt,\y) 
 			node[anchor=east] {\my}; 
%labels 
\node[below=0.6cm] at (x axis mid) {hour};
\node[rotate=90, left=1.2cm] at (y axis mid) {$\lambda$};

\draw (0,1)--(1,1);
\draw (1,2)--(2,2);
\draw (2,2.6)--(3,2.6);
\draw (3,2.8)--(4,2.8);
\draw (4,3.)--(5,3.);
\draw (5,3.1)--(6,3.1);
\draw (6,2.7)--(7,2.7);
\draw (7,1.9)--(8,1.9);
\draw (8,2.5)--(9,2.5);
\draw (9,3.3)--(10,3.3);
\draw (10,3.5)--(11,3.5);
\draw (11,2.3)--(12,2.3);
\draw (12,1.2)--(13,1.2);
\end{tikzpicture}
 \caption{A demand profile of the arrival rate $\lambda$ modeled as constant over each hour.}
 \label{fig:loadprofile}
\end{figure}


It is also easy to find the service distribution from the cash registers.
The first item scanned after a payment determines the start of a new service, and the payment closes the service.
(As there is always a bit of time between the payment and the start of a new service we might add 15 seconds, say, to any service.)
To keep things simple here, we just model the service time distribution as exponential with a mean of $1.5$ minutes.

We also \emph{model} the behavior of all the cashiers together (a multi-server queue) as a single fast server.
Thus, we neglect any differences between a station with, for instance, 3 cashiers and a single server that works 3 times as fast as a normal cashier.
(We analyze in~\cref{ex:27} the quality of this approximation.)
As yet another simplification, we change the objective somewhat such that the number of jobs in the system, rather than the number in queue, should not exceed 10.

We now find a formula to convert the demand profile into the \emph{load profile}, which is the minimal number of servers per hour needed to meet the service objective. We already know for the $M/M/1$ that $\P{L>10}=\rho^{11}$. Combining this with the objective $\P{L>10}\leq 1\%$, we get that $\rho^{11}\leq 0.01$, which translates into $\rho \leq 0.67$. Using that $\rho = \lambda \E S/c$ and our estimate $\E{S}=1.5$ minutes, we get the following rough bound on $c$:
\begin{equation*}
c \geq \frac{\lambda \E S}{0.67} \approx \frac{3}2 \cdot \lambda \cdot 1.5 = 2.25 \lambda,
\end{equation*}
where $\lambda$ is the arrival rate (per minute, \emph{not} per hour).
For instance, for the hour from 12 to 13, we read in the demand profile in~\cref{fig:loadprofile} that $\lambda= 120$ customers per hour, hence $c=2.25 \cdot 120/60 = 4.5$. With this formula, the conversion of the demand profile to the load profile becomes trivial: divide the hourly arrival rate by $60$ and multiply by
$2.25$.

The last step is to \emph{cover the load profile with service shifts}.
This is typically not easy since shifts have to satisfy all kinds of rules, such as: after 2 hours of work a cashier should take a break of at least 10 minutes; a shift length must be at least four hours, and no longer than 9 hours including breaks; when the shift is longer than 4 hours it needs to contain at least one break of 30 minutes; and so on.
These shifts also have different costs: shifts with hours after 18h are more expensive per hour; when the supermarket covers traveling costs, short shifts have higher marginal traveling costs; and so on.

The usual way to solve such covering problems is by means of an integer
problem. First generate all (or a subset of the) allowed shift types
with associated starting times. For instance, suppose only 4 shift
plans are available
\begin{enumerate}
\item $++-++$
\item $+++-+$
\item $++-+++$
\item $+++-++$,
\end{enumerate}
where a $+$ indicates a working hour and $-$ a break of an hour. Then
generate shift types for each of these plans with starting times
$8$am, $9$am, and so on, until the end of the day. Thus, a shift type
is a shift plan that starts at a certain hour. Let $x_i$ be the number
of shifts of type $i$ and $c_i$ the cost of this type. Write $t\in s_i$ if
hour $t$ is covered by shift type $i$. Then the problem is to solve
\begin{equation*}
 \min \sum_i c_i x_i,
\end{equation*}
such that 
\begin{equation*}
 \sum_i x_i \1{t \in s_i} \geq 2.25 \frac{\lambda_t}{60}
\end{equation*}
for all hours $t$ the shop is open and $\lambda_t$ is the demand for
hour $t$.





\opt{solutionfiles}{
\Closesolutionfile{hint}
\Closesolutionfile{ans}
\subsection*{Hints}
\input{hint}
\subsection*{Solutions}
\input{ans}
}



%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../companion"
%%% End:
